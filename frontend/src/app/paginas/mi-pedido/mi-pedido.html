<div class="container py-5">

  <!-- CARRITO VACÍO -->
  <div *ngIf="itemsDelCarrito.length === 0" class="text-center py-5 my-5">
    <i class="bi bi-basket3 fs-1 text-muted mb-4"></i>
    <p class="text-muted fs-3 fw-bold">Tu carrito está vacío</p>
    <a routerLink="/cliente/catalogo" class="btn btn-primary btn-lg px-5 mt-3">
      Ir a la tienda
    </a>
  </div>

  <!-- CARRITO CON PRODUCTOS -->
  <div *ngIf="itemsDelCarrito.length > 0" class="row g-4">

    <!-- LISTA DE PRODUCTOS -->
    <div class="col-lg-8">

      <div class="card shadow-sm mb-4" *ngFor="let item of itemsDelCarrito">
        <div class="card-body p-4">

          <div class="row align-items-center g-3">

            <!-- IMAGEN -->
            <div class="col-3 col-md-2">
              <img [src]="item.imagenUrl || 'assets/imagenes/default-torta.jpg'"
                   [alt]="item.nombre"
                   class="img-fluid rounded-3 shadow-sm"
                   style="height: 110px; width: 100%; object-fit: cover;">
            </div>

            <!-- DETALLES -->
            <div class="col-9 col-md-10">
              <div class="d-flex justify-content-between align-items-start">

                <div class="flex-grow-1 pe-4">

                  <!-- NOMBRE Y BADGES -->
                  <h5 class="mb-2 fw-bold">{{ item.nombre }}</h5>

                  <div *ngIf="item.esOfertaEspecial" class="mb-2">
                    <span class="badge bg-success fs-6 px-3 py-2">REGALO 100% GRATIS</span>
                  </div>

                  <div *ngIf="!item.esOfertaEspecial && (item.descuentoAplicado ?? 0) > 0" class="mb-2">
                    <span class="badge bg-danger fs-6 px-3">
                      -{{ ((item.descuentoAplicado ?? 0) * 100).toFixed(0) }}% OFF
                    </span>
                  </div>

                  <!-- PERSONALIZACIÓN EXTRA - AHORA SÍ SE VE PERFECTO -->
                  <div *ngIf="item.personalizacion" class="mt-3 p-3 bg-light rounded-3 border-start border-4 border-warning">
                    <p class="mb-2 text-primary fw-bold small">
                      Personalización Extra
                    </p>

                    <!-- LISTA DE ADICIONALES (AHORA CON NOMBRE Y PRECIO REAL) -->
                    <div *ngIf="item.personalizacion.adicionalesSeleccionados?.length > 0" class="mb-2">
                      <div *ngFor="let adicionalId of item.personalizacion.adicionalesSeleccionados" 
                           class="d-flex justify-content-between small mb-1">
                        <span>• {{ obtenerNombreAdicional(adicionalId) }}</span>
                        <span class="text-success fw-bold">
                          + S/ {{ obtenerCostoAdicional(adicionalId) | number:'1.2-2' }}
                        </span>
                      </div>
                    </div>

                    <!-- INSTRUCCIONES ESPECIALES -->
                    <p *ngIf="item.personalizacion.descripcionExtra" 
                       class="small mt-2 mb-1 fst-italic text-muted">
                      "{{ item.personalizacion.descripcionExtra }}"
                    </p>

                    <!-- COSTO ADICIONAL TOTAL -->
                    <div class="d-flex justify-content-between mt-2 pt-2 border-top border-light">
                      <small class="text-muted fw-bold">Costo adicional total</small>
                      <strong class="text-success">
                        S/ {{ item.personalizacion.costoAdicional | number:'1.2-2' }}
                      </strong>
                    </div>
                  </div>

                  <!-- CANTIDAD -->
                  <div class="d-flex align-items-center gap-3 mt-3">
                    <button class="btn btn-outline-secondary btn-sm rounded-circle" 
                            (click)="cambiarCantidad(item, -1)">−</button>
                    <span class="fw-bold fs-4 px-3">{{ item.cantidad }}</span>
                    <button class="btn btn-outline-secondary btn-sm rounded-circle" 
                            (click)="cambiarCantidad(item, 1)">+</button>
                  </div>

                </div>

                <!-- PRECIO Y ELIMINAR -->
                <div class="text-end">
                  <p class="fs-3 fw-bold text-success mb-1">
                    S/ {{ (item.precioUnitario * item.cantidad) | number:'1.2-2' }}
                  </p>
                  <p class="text-muted small mb-3" 
                     *ngIf="(item.descuentoAplicado ?? 0) > 0 || item.esOfertaEspecial">
                    <del>S/ {{ (item.precioBase * item.cantidad) | number:'1.2-2' }}</del>
                  </p>
                  <button class="btn btn-sm btn-outline-danger" 
                          (click)="eliminarItem(item.productoId)">
                    Eliminar
                  </button>
                </div>

              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- RESUMEN DEL PEDIDO -->
    <div class="col-lg-4">
      <div class="card shadow-lg sticky-top" style="top: 20px;">
        <div class="card-body p-4">

          <h4 class="text-center mb-4 fw-bold text-primary">Resumen del Pedido</h4>

          <!-- AHORRO -->
          <div *ngIf="descuentoTotal > 0" class="bg-success-subtle rounded-3 p-3 text-center mb-4">
            <p class="mb-1 fw-bold text-success">¡FELICITACIONES!</p>
            <p class="fs-4 fw-bold text-danger mb-0">- S/ {{ descuentoTotal | number:'1.2-2' }}</p>
            <small class="text-muted">Ahorraste con promociones</small>
          </div>

          <div class="d-flex justify-content-between mb-3 text-muted">
            <span>Subtotal sin descuento</span>
            <del>S/ {{ subtotalSinDescuento | number:'1.2-2' }}</del>
          </div>

          <div class="d-flex justify-content-between fs-5 fw-bold mb-4">
            <span>Subtotal a pagar</span>
            <span class="text-success">S/ {{ subtotal | number:'1.2-2' }}</span>
          </div>

          <hr class="my-4">

          <!-- GARANTÍA -->
          <div class="mb-4">
            <label class="form-label fw-bold text-primary">Paga ahora:</label>
            <select class="form-select form-select-lg rounded-3" (change)="cambiarGarantia($event)">
              <option *ngFor="let p of opcionesGarantia" [value]="p" [selected]="p === porcentajeGarantia">
                {{ p }}% → S/ {{ (subtotal * p / 100) | number:'1.2-2' }}
              </option>
            </select>
          </div>

          <div class="d-flex justify-content-between mb-2">
            <span class="fs-5">Garantía ({{ porcentajeGarantia }}%)</span>
            <strong class="text-success fs-5">S/ {{ garantia | number:'1.2-2' }}</strong>
          </div>

          <div class="d-flex justify-content-between text-danger fw-bold mb-4">
            <span class="fs-5">Resto al recibir</span>
            <strong class="fs-4">S/ {{ resto | number:'1.2-2' }}</strong>
          </div>

          <hr class="my-4">

          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="mb-0 fw-bold">Total</h3>
            <h2 class="text-success mb-0 fw-bold">S/ {{ subtotal | number:'1.2-2' }}</h2>
          </div>

          <div class="alert alert-success text-center py-3 rounded-3 mb-4">
            <strong>Paga S/ {{ garantia | number:'1.2-2' }} ahora</strong><br>
            y el resto <strong>S/ {{ resto | number:'1.2-2' }}</strong> al recibir tu torta
          </div>

          <button class="btn btn-success btn-lg w-100 py-3 fw-bold rounded-3 shadow" 
                  (click)="confirmarPedido()">
            Confirmar Pedido
          </button>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE ÉXITO -->
<div class="modal fade" id="modalExito" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-body text-center p-5">
        <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem;"></i>
        <h2 class="fw-bold text-success mt-4">¡PEDIDO RECIBIDO!</h2>
        <p class="fs-5 text-muted mb-4">
          Tu pedido ya está en cocina<br>
          <strong>Ahora solo falta pagar la garantía:</strong>
        </p>
        <h1 class="text-primary fw-bold">S/ {{ garantia | number:'1.2-2' }}</h1>
        <p class="text-muted mb-4">Resto al recibir: S/ {{ resto | number:'1.2-2' }}</p>

        <div class="d-grid gap-3">
          <button class="btn btn-success btn-lg fw-bold" 
                  routerLink="/cliente/pago-garantia" data-bs-dismiss="modal">
            PAGAR GARANTÍA AHORA
          </button>
          <button class="btn btn-outline-secondary" 
                  routerLink="/cliente/mis-pedidos" data-bs-dismiss="modal">
            Ver mis pedidos
          </button>
        </div>
      </div>
    </div>
  </div>
</div>  