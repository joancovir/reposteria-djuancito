<div class="container py-4">
  <div *ngIf="itemsDelCarrito.length === 0" class="text-center py-5">
    <p class="text-muted fs-3">Tu carrito está vacío</p>
    <a routerLink="/cliente/catalogo" class="btn btn-primary btn-lg px-5">Ir a la tienda</a>
  </div>

  <div *ngIf="itemsDelCarrito.length > 0" class="row g-4">
    <div class="col-lg-8">
      <div class="card shadow-sm mb-3" *ngFor="let item of itemsDelCarrito">
        <div class="card-body d-flex align-items-start gap-3">
          <img [src]="item.imagenUrl || 'assets/imagenes/default-torta.jpg'" 
               [alt]="item.nombre" 
               width="90" 
               class="rounded shadow-sm flex-shrink-0">

          <div class="flex-grow-1">
            <h5 class="mb-2">{{ item.nombre }}</h5>
            <div *ngIf="item.esOfertaEspecial" class="mb-2">
              <span class="badge bg-success fs-5 px-3 py-2">REGALO 100% GRATIS</span>
            </div>
            <div *ngIf="!item.esOfertaEspecial && (item.descuentoAplicado ?? 0) > 0" class="mb-2">
              <span class="badge bg-danger fs-6 px-3">
                -{{ ((item.descuentoAplicado ?? 0) * 100).toFixed(0) }}% OFF
              </span>
            </div>
            <div *ngIf="item.personalizacion" class="mt-2 p-3 border-start border-primary border-4 bg-light">
                <p class="fw-bold mb-1 text-primary small">Personalización:</p>

                <ul *ngIf="item.personalizacion.adicionalesSeleccionados?.length > 0" class="list-unstyled mb-1 ms-3">
                    <li *ngFor="let ad of item.personalizacion.adicionalesSeleccionados" class="small">
                        {{ ad.nombre }} ({{ ad.categoria }}) <span class="fw-bold text-success">+S/ {{ ad.costoAdicional | number:'1.2-2' }}</span>
                    </li>
                </ul>

                <p *ngIf="item.personalizacion.descripcionExtra" class="small mt-2 mb-0">
                    <span class="fw-bold">Instrucciones:</span> {{ item.personalizacion.descripcionExtra }}
                </p>
                
                <p *ngIf="item.personalizacion.costoAdicional > 0" class="fw-bold small mt-2 mb-0 text-success">
                    Costo Adicional Total: S/ {{ item.personalizacion.costoAdicional | number:'1.2-2' }}
                </p>

            </div>
            
            <!-- CONTROLES DE CANTIDAD -->
            <div class="d-flex align-items-center gap-3 mt-3">
              <button class="btn btn-outline-dark btn-sm" (click)="cambiarCantidad(item, -1)">−</button>
              <span class="fw-bold fs-5 px-3">{{ item.cantidad }}</span>
              <button class="btn btn-outline-dark btn-sm" (click)="cambiarCantidad(item, 1)">+</button>
            </div>
          </div>

          <!-- PRECIOS -->
          <div class="text-end flex-shrink-0">
            <!-- PRECIO FINAL (con descuento aplicado) -->
            <p class="fs-4 fw-bold text-success mb-1">
              S/ {{ (item.precioUnitario * item.cantidad) | number:'1.2-2' }}
            </p>

            <p class="text-muted small mb-3" 
               *ngIf="(item.descuentoAplicado ?? 0) > 0 || item.esOfertaEspecial">
              <del>S/ {{ (item.precioBase * item.cantidad) | number:'1.2-2' }}</del>
            </p>

            <button class="btn btn-sm btn-danger" (click)="eliminarItem(item.productoId)">
              Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- RESUMEN DEL PEDIDO -->
    <div class="col-lg-4">
      <div class="card shadow sticky-top" style="top: 90px;">
        <div class="card-body">

          <h4 class="mb-4 text-center">Resumen del Pedido</h4>

          <!-- AHORRO TOTAL -->
          <div class="bg-success-subtle p-3 rounded mb-3 text-center" *ngIf="descuentoTotal > 0">
            <div class="fs-5 fw-bold text-success">FELICITACIONES</div>
            <div class="fs-4 text-danger fw-bold">- S/ {{ descuentoTotal | number:'1.2-2' }}</div>
            <small class="text-muted">Ahorraste con promociones</small>
          </div>

          <!-- SUBTOTAL SIN DESCUENTO -->
          <div class="d-flex justify-content-between text-muted mb-2">
            <span>Subtotal sin descuento</span>
            <del>S/ {{ subtotalSinDescuento | number:'1.2' }}</del>
          </div>

          <!-- SUBTOTAL CON DESCUENTO -->
          <div class="d-flex justify-content-between fs-5 fw-bold mb-4">
            <span>Subtotal a pagar</span>
            <span class="text-success">S/ {{ subtotal | number:'1.2-2' }}</span>
          </div>

          <hr>

          <!-- GARANTÍA -->
          <div class="mb-4">
            <label class="form-label fw-bold text-primary">Paga ahora:</label>
            <select class="form-select form-select-lg" (change)="cambiarGarantia($event)">
              <option *ngFor="let p of opcionesGarantia" [value]="p" [selected]="p === porcentajeGarantia">
                {{ p }}% → S/ {{ (subtotal * p / 100) | number:'1.2-2' }}
              </option>
            </select>
          </div>

          <div class="d-flex justify-content-between text-primary fw-bold mb-2">
            <span>Garantía ({{ porcentajeGarantia }}%)</span>
            <strong>S/ {{ garantia | number:'1.2-2' }}</strong>
          </div>
          <div class="d-flex justify-content-between text-muted small mb-4">
            <span>Resto al recibir</span>
            <strong>S/ {{ resto | number:'1.2-2' }}</strong>
          </div>

          <hr class="my-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="mb-0">Total</h3>
            <h2 class="text-success mb-0">S/ {{ subtotal | number:'1.2-2' }}</h2>
          </div>

          <div class="alert alert-success text-center py-3 mb-4">
            <strong>Paga S/ {{ garantia | number:'1.2-2' }} ahora</strong><br>
            y el resto <strong>S/ {{ resto | number:'1.2-2' }}</strong> al recibir tu torta
          </div>

          <button class="btn btn-success btn-lg w-100 py-3 fw-bold" (click)="confirmarPedido()">
            Confirmar Pedido
          </button>

        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalExito" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-body text-center p-5">
        <div class="mb-4">
          <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem;"></i>
        </div>
        <h2 class="fw-bold text-success mt-3">¡PEDIDO RECIBIDO!</h2>
        <p class="fs-5 text-muted mb-4">
          Tu pedido ya está en cocina<br>
          <strong>Ahora solo falta pagar la garantía de:</strong>
        </p>
        <h1 class="text-primary fw-bold">S/ {{ garantia | number:'1.2-2' }}</h1>
        <p class="text-muted">Resto al recibir: S/ {{ resto | number:'1.2-2' }}</p>

        <div class="d-grid gap-3 mt-4">
          <button class="btn btn-success btn-lg fw-bold" 
                  routerLink="/cliente/pago-garantia"
                  data-bs-dismiss="modal">
            PAGAR GARANTÍA AHORA
          </button>
          <button class="btn btn-outline-secondary" 
                  routerLink="/cliente/mis-pedidos"
                  data-bs-dismiss="modal">
            Ver mis pedidos
          </button>
        </div>
      </div>
    </div>
  </div>
</div>